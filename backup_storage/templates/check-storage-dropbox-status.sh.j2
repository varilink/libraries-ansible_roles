#!/usr/bin/env bash
# Script to check the current Dropbox status on the backup storage host. This is
# "Run Before Job" for an admin job so that its success or failure status is
# reflected in the job's success or failure status.

echo 'Checking current Dropbox status'
status=$(/var/lib/bacula/dropbox.py status)
echo $status

if [[ $status == 'Up to date' ]]; then
  # Consider status 'Up to date' to be success
  exit 0
else
  # Consider any status other than 'Up to date' to be failure
  /usr/sbin/exim4 -v {{ admin_user }}@{{ home_domain }} << EOM
To: {{ admin_user }}@{{ home_domain }}
From: bacula@{{ home_domain }}
Subject: Dropbox status on the backup storage host
I have detected that the status of the Dropbox service on the backup storage host is NOT 'Up to date'. It is instead reported as:
$status
EOM
  exit 1
fi
